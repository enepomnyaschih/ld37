var SR={attackDistance:6,attackDistanceWeb:5,cellSize:16,flyKillProbability:0.3,maxUnitSize:3,spiderEnergyFillingPerFly:0.5,spiderEnergyPerWeb:0.1,spiderEnergyRequirement:0.25,spiderEnergyHungryLeak:0.0025,spiderKillProbability:0.5,tickPerSecond:25,webAttackProbability:0.03,winConditionPercent:20,dir4:[[0,1],[-1,0],[0,-1],[1,0]],dir8:[[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1],[1,0],[1,1]],sound:function(a){var b=new Audio();b.src="audio/"+a+".ogg";b.play()},random:function(a){return Math.floor(Math.random()*a)},randomBetween:function(b,a){return SR.random(a-b+1)+b},getIjs4:function(b){var a=[];for(var c=0;c<4;++c){a.push(SR.Vector.add(b,SR.dir4[c]))}return a},getIjs8:function(b){var a=[];for(var c=0;c<8;++c){a.push(SR.Vector.add(b,SR.dir8[c]))}return a},ijToXy:function(a){return[SR.cellSize*a[1],SR.cellSize*a[0]]},xyToIj:function(a){return[a[1]/SR.cellSize,a[0]/SR.cellSize]},getXProperty:function(a){return a.$$mapValue(function(b){return b[0]+"px"})},getYProperty:function(a){return a.$$mapValue(function(b){return b[1]+"px"})}};SR.Application=function(){SR.Application._super.call(this);this.level=this.own(new JW.Property()).ownValue()};JW.extend(SR.Application,JW.UI.Component,{renderLevel:function(){return this.own(this.level.$$mapObject(function(a){return new SR.LevelView(a)},this))},startLevel:function(){var f=new SR.Level([40,40]);f.matrix.fill(0);var c=[39,0];for(var e=0;e<4;++e){for(var b=0;b<39;++b){f.matrix.setCell(c,2);c=SR.Vector.add(c,SR.dir4[e])}}for(var b=0;b<17;++b){f.matrix.setCell([22,b+1],2);f.matrix.setCell([38-b,17],2)}for(var b=23;b<40;++b){for(var a=0;a<17;++a){f.matrix.setCell([b,a],1)}}for(var b=0;b<7;++b){f.matrix.setCell([0,15+b],3);f.matrix.setCell([12+b,39],3)}for(var b=1;b<4;++b){f.webCells.add([20,b]);f.webCells.add([21,b])}f.webCells.add([20,4]);f.obstacles.add(new SR.Obstacle({type:SR.ObstacleType.getItem("bed"),ij:[1,9],direction:3}));f.obstacles.add(new SR.Obstacle({type:SR.ObstacleType.getItem("table"),ij:[1,30],direction:0}));f.obstacles.add(new SR.Obstacle({type:SR.ObstacleType.getItem("cabinet"),ij:[28,38],direction:3}));f.units.add(new SR.Unit({ij:[20,25],direction:0,controllable:false,type:SR.UnitType.getItem("habitant")}));for(var b=0;b<1;++b){f.flies.add(new SR.Fly({ij:[20,20],angle:b*Math.PI/3}))}f.initPathingMatrices();f.spawnFly();f.spawnSpider(1);f.spawnSpider(1);f.spawnSpider(1);this.level.set(f);return this}});(window.viewha||JW.UI).template(SR.Application,{main:'<div jwclass="sr-application"><div jwid="level"></div></div>'});SR.Fly=function(a){SR.Fly._super.call(this);this.ij=new JW.Property(a.ij);this.angle=new JW.Property(a.angle);this.angleAddend=0;this.healthTicks=0;this.sittingTicks=new JW.Property(0);this._replenishHealth()};JW.extend(SR.Fly,JW.Class,{angleStepPerTick:4*Math.PI/180,minHealth:2,maxHealth:6,speed:0.9,sitProbability:0.05,sitMaxTime:175,sitMinTime:50,scaredDistance:4,move:function(f){if(this.sittingTicks.get()){var c=f.units.some(function(g){return g.type.isMinion&&SR.Vector.length8(SR.Vector.diff(g.ij.get(),this.ij.get()))<this.scaredDistance},this);this.sittingTicks.set(c?0:(this.sittingTicks.get()-1));if(this.sittingTicks.get()<=0){this.jump()}return}if(this.angleAddend===0){this.angleAddend=Math.PI*(Math.random()-0.5)}else{if(this.angleAddend>0){this.angle.set(this.angle.get()+this.angleStepPerTick);this.angleAddend=Math.max(0,this.angleAddend-this.angleStepPerTick)}else{this.angle.set(this.angle.get()-this.angleStepPerTick);this.angleAddend=Math.min(0,this.angleAddend+this.angleStepPerTick)}}var b=f.isWebCell(SR.Vector.floor(this.ij.get()));if(this.healthTicks<=0&&b){return}for(var e=0;e<4;++e){var a=SR.Vector.add(this.ij.get(),[Math.sin(this.angle.get()),Math.cos(this.angle.get())]);if(f.matrix.getCell(SR.Vector.floor(a))!==0){this.angle.set(2*Math.PI*Math.random())}else{this.ij.set(a);break}}if(f.isAboveObstacle(SR.Vector.floor(this.ij.get()))&&Math.random()<this.sitProbability){this.sittingTicks.set(SR.randomBetween(this.sitMinTime,this.sitMaxTime));return}if(f.isWebCell(SR.Vector.floor(this.ij.get()))){--this.healthTicks}else{if(b||this.healthTicks<=0){this._replenishHealth()}}},jump:function(){this.sittingTicks.set(0);this.angle.set(2*Math.PI*Math.random())},_replenishHealth:function(){this.healthTicks=SR.randomBetween(this.minHealth,this.maxHealth)}});SR.FlyView=function(a){SR.FlyView._super.call(this);this.fly=a;this.sittingAnimationTick=0;this.isClapping=false};JW.extend(SR.FlyView,JW.UI.Component,{animationPeriodMin:25,animationPeriodMax:75,renderRoot:function(c){c.addClass("sr-fly");var e=this.own(this.fly.ij.$$mapValue(SR.ijToXy));var a=this.own(SR.getXProperty(e));var g=this.own(SR.getYProperty(e));this.own(c.jwcss("left",a));this.own(c.jwcss("top",g));var b=this.own(this.fly.angle.$$mapValue(function(h){return"rotate("+(180*h/Math.PI)+"deg)"},this));this.own(c.jwcss("transform",b));var f=this.own(this.fly.sittingTicks.$$mapValue(function(h){if(h<=0){this.isClapping=false;return null}if(--this.sittingAnimationTick<=0){this.isClapping=!this.isClapping;this.sittingAnimationTick=SR.randomBetween(this.animationPeriodMin,this.animationPeriodMax)}if(this.isClapping){return(h%2===0)?"sitting-1":"sitting-2"}return"sitting"},this));this.own(c.jwclass(f))}});SR.Level=function(a){SR.Level._super.call(this);this.tick=new JW.Property(0);this.matrix=new SR.Matrix(a);this.obstacles=this.own(new JW.ObservableArray()).ownItems();this.units=this.own(new JW.ObservableArray()).ownItems();this.webCells=this.own(new JW.ObservableArray()).ownItems();this.flies=this.own(new JW.ObservableArray()).ownItems();this.paused=new JW.Property(false);this.own(this.paused.$$mapObject(function(b){return b?null:new JW.Interval(this.onTick,this,1000/SR.tickPerSecond)},this));this.pathingMatricesWithObstacles=[];this.pathingMatricesWithoutObstacles=[];this.flyLimit=6;this.flySpawnInterval=120;this.spiderLimit=3;this.spiderSpawnInterval=150;this.windowCells=[];this.achievement=new JW.Property(0);this.buildableCellCount=0;this.victory=new JW.Property(false)};JW.extend(SR.Level,JW.Class,{initPathingMatrices:function(){this.pathingMatricesWithObstacles=[];this.pathingMatricesWithObstacles.push(this._initMainPathingMatrix(true));for(var a=0;a<3;++a){this.pathingMatricesWithObstacles.push(this._extendPathingMatrix(this.pathingMatricesWithObstacles[a]))}this.pathingMatricesWithoutObstacles=[];this.pathingMatricesWithoutObstacles.push(this._initMainPathingMatrix(false));this.matrix.every(function(c,b){if(c===3){this.windowCells.push(b)}if(c===0&&!this.isAboveObstacle(b)){++this.buildableCellCount}},this)},onTick:function(){if(this.webCells.getLength()>=this.buildableCellCount*SR.winConditionPercent/100){this.victory.set(true);return}this.tick.set(this.tick.get()+1);this.units.each(JW.byMethod("move",[this]));this.flies.each(JW.byMethod("move",[this]));if(this.flies.getLength()<this.flyLimit&&(this.tick.get()%this.flySpawnInterval===0)){this.spawnFly()}var a=this.units.$filter(function(b){return b.type.isMinion},this);if(a.getLength()<this.spiderLimit&&(this.tick.get()%this.spiderSpawnInterval===0)){this.spawnSpider(SR.spiderEnergyRequirement)}a.$toArray().each(function(b){if(!this.isWebCell(b.ij.get())){b.energy.set(b.energy.get()-SR.spiderEnergyHungryLeak);if(b.energy.get()<0){this.units.removeItem(b)}}},this);this.units.performFilter(this.units.filter(JW.byField("alive")))},isPassable:function(b,a,c,f){a=a||0;var g=f?this.pathingMatricesWithObstacles[a]:this.pathingMatricesWithoutObstacles[a];if(!g.getCell(b)){return false}if(c){var e=this.units.some(function(h){return SR.Vector.length8(SR.Vector.diff(h.ij.get(),b))<=a+h.type.size},this);if(e){return false}}return true},findPath:function(f,c,b,e,g){var a=this.getDistanceMatrix(f,c,b,e,g);return this.backtracePath(a,c)},getDistanceMatrix:function(o,c,a,e,p){var m=new SR.Matrix(this.matrix.size);m.setCell(o,0);if(SR.Vector.equal(o,c)){return m}var i=[o];var l=0;var f=0;var j=0;while(l<i.length){if(l==j){++f;j=i.length;if(m.getCell(c)!=null){return m}}var h=i[l++];for(var g=0;
g<SR.dir4.length;++g){var k=SR.Vector.add(h,SR.dir4[g]);var b=m.getCell(k);if(!this.matrix.inMatrix(k)||(b!=null)){continue}var n=this.matrix.getCell(k);if(!this.isPassable(k,a,e,p)){continue}m.setCell(k,f);i.push(k)}}return m},backtracePath:function(a,b){var g=[];var i=a.getCell(b);if(i==null){return null}while(true){if(i===0){g.reverse();return g}--i;var e,f;var h=SR.random(4);for(d=0;d<4;++d){var e=(d+h)%4;f=SR.Vector.diff(b,SR.dir4[e]);if(a.getCell(f)===i){break}}g.push(e);b=f}},getSelectedUnits:function(){return this.units.$filter(function(a){return a.selected.get()},this)},isWebCell:function(a){return this.webCells.some(function(b){return SR.Vector.equal(b,a)},this)},isWallBetween:function(e,c){var k=SR.Vector.diff(c,e);var j=SR.Vector.length(k);var h=SR.Vector.mult(k,1/j);j=Math.round(j);for(var g=1;g<j;++g){e=SR.Vector.add(e,h);var f=SR.Vector.round(e);if(this.matrix.getCell(f)!==0){return true}}return false},isAboveObstacle:function(a){return this.obstacles.some(function(b){return b.type.isInRectangle(b.getRelativeIj(a))},this)},getEatableFly:function(a){return this.flies.search(function(e){var c=SR.Vector.floor(SR.Vector.diff(e.ij.get(),[0.5,0.5]));var b=SR.Vector.floor(SR.Vector.add(e.ij.get(),[0.5,0.5]));return(e.healthTicks<=0)&&SR.Vector.isBetween(a,c,b)},this)},spawnFly:function(){var a=this.windowCells[SR.random(this.windowCells.length)];a=SR.Vector.max(a,[1,1]);a=SR.Vector.min(a,SR.Vector.diff(this.matrix.size,[2,2]));this.flies.add(new SR.Fly({ij:a,angle:2*Math.PI*Math.random()}))},spawnSpider:function(b){var a=this.webCells.get(SR.random(this.webCells.getLength()));this.units.add(new SR.Unit({ij:a,direction:SR.random(4),controllable:true,type:SR.UnitType.getItem("spider"),energy:b}))},_initMainPathingMatrix:function(f){var a=new SR.Matrix(this.matrix.size);for(var e=0;e<a.size[0];++e){for(var b=0;b<a.size[1];++b){var c=[e,b];a.setCell(c,this._isPassable(c,f))}}return a},_extendPathingMatrix:function(g){var b=new SR.Matrix(this.matrix.size);for(var f=0;f<b.size[0];++f){for(var c=0;c<b.size[1];++c){var e=[f,c];var k=true;for(var h=0;h<8;++h){var a=SR.Vector.add(e,SR.dir8[h]);if(!b.inMatrix(a)||!g.getCell(a)){var k=false;break}}b.setCell(e,k)}}return b},_isPassable:function(b,c){if(this.matrix.getCell(b)!==0){return false}if(!c){return true}var a=this.obstacles.some(function(e){return e.type.hitChecker(e.getRelativeIj(b))},this);if(a){return false}return true}});SR.LevelView=function(a){SR.LevelView._super.call(this);this.level=a;this.cells=new SR.Matrix(this.level.matrix.size);this.selectionPoint1=new JW.Property();this.selectionPoint2=new JW.Property()};JW.extend(SR.LevelView,JW.UI.Component,{renderRoot:function(a){this.own(a.jwon("mousedown",this._onMouseDown,this));this.own($(window).jwon("mousemove",this._onMouseMove,this));this.own($(window).jwon("mouseup",this._onMouseUp,this));this.own(a.jwon("contextmenu",JW.UI.preventDefault));this.own($(window).jwon("keypress",this._onKeyPress,this))},renderMatrix:function(g){var h=this.level;for(var f=0;f<h.matrix.size[0];++f){var c=jQuery('<div class="sr-level-row"></div>');for(var b=0;b<h.matrix.size[1];++b){var e=[f,b];var a=jQuery('<div class="sr-level-cell"></div>');this.cells.setCell(e,a);a.attr("sr-i",f);a.attr("sr-j",b);a.attr("sr-type",this.level.matrix.getCell(e));c.append(a)}c.append('<div class="sr-clear"></div>');g.append(c)}},renderObstacles:function(){return this.own(this.level.obstacles.$$mapObjects(function(a){return new SR.ObstacleView(a)},this))},renderUnits:function(){return this.own(this.level.units.$$mapObjects(function(a){return a.type.viewCreator(a)},this))},renderFlies:function(){return this.own(this.level.flies.$$mapObjects(function(a){return new SR.FlyView(a)},this))},renderWebCells:function(a){this.own(this.level.webCells.createMapper({createItem:function(c){var b=$('<div class="sr-web-cell"></div>');var e=SR.ijToXy(c);b.css("left",e[0]+"px");b.css("top",e[1]+"px");a.append(b);return b},destroyItem:function(b){b.remove()},scope:this}))},renderAchievement:function(a){var b=this.own(this.level.achievement.$$mapValue(function(c){switch(c){case 0:return"Click or surround spiders to select them";case 1:return"Right-click to move spiders to a location";case 2:return"Press space bar to activate web building mode";case 10:return"You can build web only in the corners between walls and interior objects";case 11:return"Hungry spiders can not build, and they may die hungry death if they stay outside the web";case 12:return"Catch and eat flies to feed the spiders";case 13:return"Avoid engaging a guy to keep your minions alive";default:return"Cover "+SR.winConditionPercent+"% of all territory with web to achieve the victory"}},this));this.own(a.jwtext(b))},renderVictory:function(a){this.own(a.jwshow(this.level.victory))},renderRestart:function(a){a.jwon("click",function(){application.level.set(null);application.startLevel()},this)},renderSelection:function(a){this.own(new JW.Updater([this.selectionPoint1,this.selectionPoint2],function(f,e){if(!f||!e){a.css("display","none");return}var c=SR.Vector.min(f,e);var b=SR.Vector.max(f,e);a.css("display","");a.css("left",c[0]+"px");a.css("top",c[1]+"px");a.css("width",(b[0]-c[0])+"px");a.css("height",(b[1]-c[1])+"px")},this))},_onMouseDown:function(f){f.preventDefault();var a=this._getPointByEvent(f);if(f.which===1){this.selectionPoint1.set(a);this.selectionPoint2.set(a)}if(f.which===3){var c=SR.Vector.floor(SR.xyToIj(a));var b=this.level.getSelectedUnits();if(b.isEmpty()){return}b.each(function(e){e.send(this.level,c)},this);if(this.level.achievement.get()===1){this.level.achievement.set(2)}}},_onMouseMove:function(b){var a=this._getPointByEvent(b);this.selectionPoint2.set(a)},_onMouseUp:function(h){var i=this.selectionPoint1.get();var g=this.selectionPoint2.get();this.selectionPoint1.set(null);this.selectionPoint2.set(null);if(!i||!g){return}var f=SR.Vector.min(i,g);var b=SR.Vector.max(i,g);var c=SR.Vector.floor(SR.xyToIj(f));var a=SR.Vector.floor(SR.xyToIj(b));this.level.units.each(function(j){var e=j.controllable&&SR.Vector.isBetween(j.ij.get(),c,a);j.selected.set(e);if(e&&this.level.achievement.get()===0){this.level.achievement.set(1)}},this)},_onKeyPress:function(b){if(b.which===32){b.preventDefault();var c=this.level.getSelectedUnits();if(c.isEmpty()){return}var a=c.some(function(e){return !e.active.get()},this);c.each(function(e){e.active.set(a)},this);if(a&&this.level.achievement.get()===2){this.level.achievement.set(10);this.own(new JW.Interval(function(){this.level.achievement.set(this.level.achievement.get()+1)},this,10000))}}},_getPointByEvent:function(a){var b=this.el.offset();return[a.pageX-b.left,a.pageY-b.top]}});(window.viewha||JW.UI).template(SR.LevelView,{main:'<div jwclass="sr-level"><div jwid="matrix"></div><div jwid="obstacles"></div><div jwid="web-cells"></div><div jwid="units"></div><div jwid="flies"></div><div jwid="achievement"></div><div jwid="victory">You win!<br><button type="button" jwid="restart">Restart</button></div><div jwid="selection"></div></div>'});SR.Matrix=function(b){SR.Matrix._super.call(this);this.size=b;this.cells=new Array(b[0]);for(var a=0;a<b[0];++a){this.cells[a]=new Array(b[1])}};JW.extend(SR.Matrix,JW.Class,{getCell:function(a){return JW.get(this.cells,a)},setCell:function(a,b){this.cells[a[0]][a[1]]=b},fill:function(c){for(var b=0;b<this.size[0];++b){for(var a=0;a<this.size[1];++a){this.cells[b][a]=c}}},inMatrix:function(a){return(a[0]>=0)&&(a[0]<this.size[0])&&(a[1]>=0)&&(a[1]<this.size[1])},ijRandom:function(){return[SR.random(this.size[0]),SR.random(this.size[1])]},ijCenter:function(){return SR.Vector.round(SR.Vector.mult([this.size[0],this.size[1]],0.5))},getRect:function(a,b){return{iMin:Math.max(0,a[0]-b),iMax:Math.min(this.size[0]-1,a[0]+b),jMin:Math.max(0,a[1]-b),jMax:Math.min(this.size[1]-1,a[1]+b)}},clamp:function(b){var a=SR.Vector.diff(this.size,[1,1]);return SR.Vector.max([0,0],SR.Vector.min(a,b))},getSideDistance:function(a){return Math.min(a[0],a[1],this.size[0]-a[0]-1,this.size[1]-a[1]-1)
},every:function(f,e){for(var c=0;c<this.size[0];++c){for(var a=0;a<this.size[1];++a){var b=[c,a];if(f.call(e||this,this.getCell(b),b)===false){return false}}}return true},some:function(b,a){return !this.every(function(){return !b.apply(this,arguments)},a||this)},eachWithin:function(c,a,k,l){var b=Math.ceil(Math.sqrt(a));var g=this.getRect(c,b);for(var f=g.iMin;f<=g.iMax;++f){for(var e=g.jMin;e<=g.jMax;++e){var h=[f,e];if(SR.Vector.lengthSqr(SR.Vector.diff(h,c))<=a){k.call(l||this,this.getCell(h),h)}}}},everyWithin8:function(e,k,h,f){var g=this.getRect(e,k);for(var c=g.iMin;c<=g.iMax;++c){for(var a=g.jMin;a<=g.jMax;++a){var b=[c,a];if(h.call(f||this,this.getCell(b),b)===false){return false}}}return true},someWithin8:function(a,e,c,b){return !this.everyWithin8(a,e,function(){return !c.apply(this,arguments)},b||this)}});SR.Obstacle=function(a){SR.Obstacle._super.call(this);this.type=a.type;this.ij=a.ij;this.direction=a.direction};JW.extend(SR.Obstacle,JW.Class,{getRelativeIj:function(a){var c=SR.dir4[this.direction];var b=SR.Vector.diff(a,this.ij);return SR.Vector.rotate(b,-this.direction)}});SR.ObstacleType=function(a){SR.ObstacleType._super.call(this);this.id=a.id;this.size=a.size;this.ijAction=a.ijAction;this.actionTickCount=a.actionTickCount||0;this.hitChecker=a.hitChecker||this.hitChecker};JW.extend(SR.ObstacleType,JW.Class,{hitChecker:function(a){return this.isInRectangle(a)},isInRectangle:function(a){return SR.Vector.isBetween(a,[0,0],SR.Vector.diff(this.size,[1,1]))}});JW.makeRegistry(SR.ObstacleType);SR.ObstacleType.registerItem(new SR.ObstacleType({id:"bed",size:[9,19],ijAction:[4,9],actionTickCount:150,hitChecker:function(a){return this.isInRectangle(a)&&(a[1]<6||a[1]>=13)}}));SR.ObstacleType.registerItem(new SR.ObstacleType({id:"table",size:[5,9],ijAction:[8,4],actionTickCount:150}));SR.ObstacleType.registerItem(new SR.ObstacleType({id:"cabinet",size:[7,11],ijAction:[10,5],actionTickCount:150}));SR.ObstacleView=function(a){SR.ObstacleView._super.call(this);this.obstacle=a};JW.extend(SR.ObstacleView,JW.UI.Component,{renderRoot:function(b){b.addClass("sr-obstacle");b.attr("sr-type",this.obstacle.type.id);var c=SR.ijToXy(this.obstacle.ij);b.css("left",c[0]+"px");b.css("top",c[1]+"px");var a=SR.ijToXy(this.obstacle.type.size);b.css("width",a[0]+"px");b.css("height",a[1]+"px");b.css("transform","rotate("+(-90*this.obstacle.direction)+"deg)")}});SR.Unit=function(a){SR.Unit._super.call(this);this.ij=new JW.Property(a.ij);this.direction=new JW.Property(a.direction);this.movement=new JW.Property(0);this.controllable=a.controllable;this.type=a.type;this.ijTarget=new JW.Property();this.path=[];this.selected=new JW.Property(false);this.animationTick=new JW.Property(0);this.alive=true;this.energy=new JW.Property(JW.defn(a.energy,1));this.active=new JW.Property(false);this.actionTick=0;this.actingObstacle=null;this.targetObstacle=null;this.attackType=new JW.Property();this.attackTick=0;this.attackIj=new JW.Property()};JW.extend(SR.Unit,JW.Class,{move:function(e){if(this.attackIj.get()){if(this.attackTick<=0){this.attackIj.set(null);this.attackType.set(null)}else{--this.attackTick;return}}var b=this.type.speed;if(this.isMoving()){this.animationTick.set(this.animationTick.get()+b)}while(b&&this.isMoving()){var a=-this.movement.get();if(b<a){this.movement.set(this.movement.get()+b);b=0}else{if(this.path.length){b-=a;this.movement.set(-1);var c=this.path[0];this.path.splice(0,1);this.ij.set(SR.Vector.add(this.ij.get(),SR.dir4[c]));this.direction.set(c)}else{this.movement.set(0);this.animationTick.set(0)}}}this.type.mover(this,e)},send:function(c,a,b){this.ijTarget.set(a);this.path=c.findPath(this.ij.get(),a,this.type.size,b,this.type.hitsObstacles)||[]},isMoving:function(){return this.path.length||this.movement.get()!==0}});SR.UnitType=function(a){SR.UnitType._super.call(this);this.id=a.id;this.speed=a.speed;this.size=a.size||0;this.isMinion=a.isMinion||false;this.hitsObstacles=a.hitsObstacles||false;this.viewCreator=a.viewCreator||this.viewCreator;this.mover=a.mover||this.mover};JW.extend(SR.UnitType,JW.Class,{viewCreator:function(a){return new SR.UnitView(a)},mover:function(a,b){}});JW.makeRegistry(SR.UnitType);SR.UnitType.registerItem(new SR.UnitType({id:"spider",speed:0.4,isMinion:true,viewCreator:function(a){return new SR.SpiderUnitView(a)},mover:function(e,h){var c=h.getEatableFly(e.ij.get());if(c&&e.energy.get()!==1){h.flies.removeItem(c);e.energy.set(Math.min(1,e.energy.get()+SR.spiderEnergyFillingPerFly))}if(!e.isMoving()){var g=h.units.search(function(i){return(i!==e)&&i.type.isMinion&&SR.Vector.equal(i.ij.get(),e.ij.get())},this);if(g){e.send(h,SR.Vector.add(e.ij.get(),SR.dir4[SR.random(4)]))}}if(h.isWebCell(e.ij.get())){return}if(!e.active.get()){return}if(h.isAboveObstacle(e.ij.get())){return}if(e.energy.get()<SR.spiderEnergyRequirement){e.active.set(false);return}var b=0;for(var f=0;f<4;++f){var a=SR.Vector.add(e.ij.get(),SR.dir4[f]);if(h.matrix.getCell(a)===3){b=-100}if(h.isWebCell(a)||!h.isPassable(a)||h.isAboveObstacle(a)){++b}}if(b<2){return}e.energy.set(e.energy.get()-SR.spiderEnergyPerWeb);h.webCells.add(e.ij.get())}}));SR.UnitType.registerItem(new SR.UnitType({id:"habitant",speed:0.2,size:SR.maxUnitSize,hitsObstacles:true,viewCreator:function(a){return new SR.HabitantUnitView(a)},mover:function(f,i){if(f.actingObstacle){if(f.actionTick>f.actingObstacle.type.actionTickCount){f.targetObstacle=null;f.actingObstacle=null;f.actionTick=0}else{++f.actionTick;return}}var a=i.units.search(function(j){return j.type.isMinion&&SR.Vector.length(SR.Vector.diff(f.ij.get(),j.ij.get()))<=SR.attackDistance&&!i.isWallBetween(f.ij.get(),j.ij.get())},this);if(a){f.attackIj.set(a.ij.get());f.attackTick=25;f.attackType.set(0);if(Math.random()<SR.spiderKillProbability){a.alive=false}return}var h=i.flies.search(function(k){var j=SR.Vector.floor(k.ij.get());return k.sittingTicks.get()>0&&SR.Vector.length(SR.Vector.diff(f.ij.get(),j))<=SR.attackDistance&&!i.isWallBetween(f.ij.get(),j)},this);if(h){f.attackIj.set(h.ij.get());f.attackTick=25;f.attackType.set(2);if(Math.random()<SR.flyKillProbability){i.flies.removeItem(h)}else{h.jump()}return}var e=i.webCells.search(function(j){return SR.Vector.length(SR.Vector.diff(f.ij.get(),j))<=SR.attackDistanceWeb&&!i.isWallBetween(f.ij.get(),j)&&Math.random()<SR.webAttackProbability},this);if(e){f.attackIj.set(e);f.attackTick=10;f.attackType.set(1);i.webCells.removeItem(e);return}if(!f.targetObstacle){var c=i.obstacles.filter(function(j){if(!j.type.ijAction){return false}return !i.units.some(function(k){return(k.type.id==="habitant")&&(k.targetObstacle===j)},f)},f);if(!c.length){return}f.targetObstacle=c[SR.random(c.length)]}var b=SR.Vector.rotate(f.targetObstacle.type.ijAction,f.targetObstacle.direction);var g=SR.Vector.add(f.targetObstacle.ij,b);if(SR.Vector.equal(f.ij.get(),g)&&f.movement.get()===0){f.actingObstacle=f.targetObstacle}else{if(!f.isMoving()){f.send(i,g)}}}}));SR.UnitView=function(a){SR.UnitView._super.call(this);this.unit=a;this.transform=null};JW.extend(SR.UnitView,JW.UI.Component,{beforeRender:function(){this._super();this.transform=this.own(new JW.Functor([this.unit.direction,this.unit.attackIj],function(c,b){if(b){var a=SR.Vector.diff(b,this.unit.ij.get());var e=-Math.atan2(a[1],a[0]);return"rotate("+(180*e/Math.PI+90)+"deg)"}return"rotate("+(-90*c)+"deg)"},this)).target},renderRoot:function(b){var c=this.own(new JW.Functor([this.unit.ij,this.unit.direction,this.unit.movement],function(g,h,f){return SR.ijToXy(SR.Vector.add(g,SR.Vector.mult(SR.dir4[h],f)))},this)).target;var a=this.own(SR.getXProperty(c));var e=this.own(SR.getYProperty(c));this.own(b.jwcss("left",a));this.own(b.jwcss("top",e))},renderView:function(b){b.attr("sr-type",this.unit.type.id);var a=(2*this.unit.type.size+1)*SR.cellSize;var c=a/2;b.css("width",a+"px");b.css("height",a+"px");b.css("left",-c+"px");b.css("top",-c+"px");this.own(b.jwcss("transform",this.transform));this.own(b.jwclass("selected",this.unit.selected));this.own(b.jwclass("active",this.unit.active))
}});(window.viewha||JW.UI).template(SR.UnitView,{main:'<div jwclass="sr-unit"><div jwid="view"></div></div>'});SR.HabitantUnitView=function(a){SR.HabitantUnitView._super.call(this,a);this.animationPoint=null};JW.extend(SR.HabitantUnitView,SR.UnitView,{bodyRotationAmplitude:10,legExtrusionAmplitude:40,animationPeriod:4,beforeRender:function(){this._super();this.animationPoint=this.own(this.unit.animationTick.$$mapValue(function(a){return 2*Math.abs(2*JW.smod(a/this.animationPeriod+0.25,1))-1},this))},renderBody:function(b){var a=this.own(this.animationPoint.$$mapValue(function(c){return"rotate("+(-c*this.bodyRotationAmplitude)+"deg)"},this));this.own(b.jwcss("transform",a))},renderLeftLeg:function(a){this._renderLeg(a,1)},renderRightLeg:function(a){this._renderLeg(a,-1)},renderWeapon:function(b){this.own(b.jwattr("sr-weapon",this.unit.attackType));this.own(b.jwcss("transform",this.transform));var c=this.own(new JW.Functor([this.unit.ij,this.unit.attackIj],function(f,g){return g?SR.ijToXy(SR.Vector.diff(g,f)):[0,0]},this)).target;var a=this.own(SR.getXProperty(c));var e=this.own(SR.getYProperty(c));this.own(b.jwcss("left",a));this.own(b.jwcss("top",e))},_renderLeg:function(a,b){this.own(new JW.Updater([this.animationPoint],function(c){c*=b;a.css("left",(c>=0)?"56px":(56+this.legExtrusionAmplitude*c+"px"));a.css("width",Math.abs(c)*this.legExtrusionAmplitude+"px");a.css("background-position-x",(c>=0)?(this.legExtrusionAmplitude*c-48+"px"):"0")},this))}});(window.viewha||JW.UI).template(SR.HabitantUnitView,{main:'<div jwclass="sr-habitant" class="sr-unit"><div jwid="view" class="sr-unit-view"><div jwid="left-leg"></div><div jwid="right-leg"></div><div jwid="body"></div></div><div jwid="weapon"></div></div>'});SR.SpiderUnitView=function(a){SR.SpiderUnitView._super.call(this,a)};JW.extend(SR.SpiderUnitView,SR.UnitView,{renderAss:function(b){var a=this.own(this.unit.energy.$$mapValue(function(c){return"scale("+(c*0.6+0.4)+")"},this));this.own(b.jwcss("transform",a))}});(window.viewha||JW.UI).template(SR.SpiderUnitView,{main:'<div jwclass="sr-spider" class="sr-unit"><div jwid="view" class="sr-unit-view"><div jwid="ass"></div></div></div>'});SR.Vector={add:function(e,c){return[e[0]+c[0],e[1]+c[1]]},diff:function(e,c){return[e[0]-c[0],e[1]-c[1]]},mult:function(b,e){return[e*b[0],e*b[1]]},equal:function(e,c){return(e[0]===c[0])&&(e[1]===c[1])},length:function(b){return Math.sqrt(SR.Vector.lengthSqr(b))},lengthSqr:function(b){return b[0]*b[0]+b[1]*b[1]},length8:function(b){return Math.max(Math.abs(b[0]),Math.abs(b[1]))},lerp:function(f,e,g){return SR.Vector.add(f,SR.Vector.mult(SR.Vector.diff(e,f),g))},isBetween:function(c,e,b){return(c[0]>=e[0])&&(c[1]>=e[1])&&(c[0]<=b[0])&&(c[1]<=b[1])},round:function(b){return[Math.round(b[0]),Math.round(b[1])]},floor:function(b){return[Math.floor(b[0]),Math.floor(b[1])]},ceil:function(b){return[Math.ceil(b[0]),Math.ceil(b[1])]},min:function(e,c){return[Math.min(e[0],c[0]),Math.min(e[1],c[1])]},max:function(e,c){return[Math.max(e[0],c[0]),Math.max(e[1],c[1])]},norm:function(b){return SR.Vector.mult(b,1/SR.Vector.length(b))},norm8:function(b){return[JW.sgn(b[0]),JW.sgn(b[1])]},parse:function(a){a=a.split(",");return[+a[0],+a[1]]},rotate:function(b,c){var e=SR.dir4[JW.mod(c,4)];return[e[1]*b[0]+e[0]*b[1],-e[0]*b[0]+e[1]*b[1]]}};var application;$(function(){application=new SR.Application().renderTo("body").startLevel()});