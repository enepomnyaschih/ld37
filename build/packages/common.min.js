var SR={cellSize:16,tickPerSecond:25,dir4:[[0,1],[-1,0],[0,-1],[1,0]],dir8:[[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1],[1,0],[1,1]],sound:function(a){var b=new Audio();b.src="audio/"+a+".ogg";b.play()},random:function(a){return Math.floor(Math.random()*a)},getIjs4:function(b){var a=[];for(var c=0;c<4;++c){a.push(SR.Vector.add(b,SR.dir4[c]))}return a},getIjs8:function(b){var a=[];for(var c=0;c<8;++c){a.push(SR.Vector.add(b,SR.dir8[c]))}return a},ijToXy:function(a){return[SR.cellSize*a[1],SR.cellSize*a[0]]},xyToIj:function(a){return[a[1]/SR.cellSize,a[0]/SR.cellSize]},getXProperty:function(a){return a.$$mapValue(function(b){return b[0]+"px"})},getYProperty:function(a){return a.$$mapValue(function(b){return b[1]+"px"})}};SR.Application=function(){SR.Application._super.call(this);this.level=this.own(new JW.Property()).ownValue()};JW.extend(SR.Application,JW.UI.Component,{renderLevel:function(){return this.own(this.level.$$mapObject(function(a){return new SR.LevelView(a)},this))},startLevel:function(){var e=new SR.Level(40);e.matrix.fill(0);var b=[39,0];for(var c=0;c<4;++c){for(var a=0;a<39;++a){e.matrix.setCell(b,2);b=SR.Vector.add(b,SR.dir4[c])}}for(var a=0;a<15;++a){e.matrix.setCell([24,a+1],1);e.matrix.setCell([38-a,15],1)}e.obstacles.add(new SR.Obstacle({type:SR.ObstacleType.getItem("bed"),ij:[1,10],direction:3}));e.units.add(new SR.Unit({ij:[35,5],direction:1,controllable:true,type:SR.UnitType.getItem("spider")}));this.level.set(e);return this}});(window.viewha||JW.UI).template(SR.Application,{main:'<div jwclass="sr-application"><div jwid="level"></div></div>'});SR.Level=function(a){SR.Level._super.call(this);this.tick=new JW.Property(0);this.matrix=new SR.Matrix(a);this.obstacles=new JW.ObservableArray();this.units=new JW.ObservableArray();this.paused=new JW.Property(false);this.own(this.paused.$$mapObject(function(b){return b?null:new JW.Interval(this.onTick,this,1000/SR.tickPerSecond)},this))};JW.extend(SR.Level,JW.Class,{onTick:function(){this.tick.set(this.tick.get()+1);this.units.each(JW.byMethod("move",[this]))},isPassable:function(b,c){if(this.matrix.getCell(b)!==0){return false}var a=this.obstacles.some(function(h){var l=SR.dir4[h.direction];var j=SR.Vector.diff(h.type.size,[1,1]);var g=[l[1]*j[0]+l[0]*j[1],-l[0]*j[0]+l[1]*j[1]];var k=h.ij;var i=SR.Vector.add(k,g);var f=SR.Vector.min(k,i);var e=SR.Vector.max(k,i);return SR.Vector.isBetween(b,f,e)},this);if(a){return false}if(c){var d=this.units.some(function(e){return SR.Vector.equal(e.ij.get(),b)},this);if(d){return false}}return true},findPath:function(d,b,c){var a=this.getDistanceMatrix(d,b,c);return this.backtracePath(a,b)},getDistanceMatrix:function(m,b,c){var k=new SR.Matrix(this.matrix.size);k.setCell(m,0);if(SR.Vector.equal(m,b)){return k}var g=[m];var j=0;var d=0;var h=0;while(j<g.length){if(j==h){++d;h=g.length}var f=g[j++];for(var e=0;e<SR.dir4.length;++e){var i=SR.Vector.add(f,SR.dir4[e]);var a=k.getCell(i);if(!this.matrix.inMatrix(i)||(a!=null)){continue}var l=this.matrix.getCell(i);if(!this.isPassable(i,c)){continue}k.setCell(i,d);if(SR.Vector.equal(b,i)){return k}g.push(i)}}return k},backtracePath:function(a,b){var e=[];var g=a.getCell(b);if(g==null){return null}while(true){if(g===0){e.reverse();return e}--g;var f,c;for(f=0;f<4;++f){c=SR.Vector.diff(b,SR.dir4[f]);if(a.getCell(c)===g){break}}e.push(f);b=c}}});SR.LevelView=function(a){SR.LevelView._super.call(this);this.level=a;this.cells=new SR.Matrix(this.level.matrix.size);this.selectionPoint1=new JW.Property();this.selectionPoint2=new JW.Property()};JW.extend(SR.LevelView,JW.UI.Component,{renderRoot:function(a){this.own(a.jwon("mousedown",this._onMouseDown,this));this.own($(window).jwon("mousemove",this._onMouseMove,this));this.own($(window).jwon("mouseup",this._onMouseUp,this));this.own(a.jwon("contextmenu",JW.UI.preventDefault))},renderMatrix:function(f){var g=this.level;for(var e=0;e<g.matrix.size;++e){var c=jQuery('<div class="sr-level-row"></div>');for(var b=0;b<g.matrix.size;++b){var d=[e,b];var a=jQuery('<div class="sr-level-cell"></div>');this.cells.setCell(d,a);a.attr("sr-i",e);a.attr("sr-j",b);a.attr("sr-type",this.level.matrix.getCell(d));c.append(a)}c.append('<div class="sr-clear"></div>');f.append(c)}},renderObstacles:function(){return this.own(this.level.obstacles.$$mapObjects(function(a){return new SR.ObstacleView(a)},this))},renderUnits:function(){return this.own(this.level.units.$$mapObjects(function(a){return new SR.UnitView(a)},this))},renderSelection:function(a){this.own(new JW.Updater([this.selectionPoint1,this.selectionPoint2],function(e,d){if(!e||!d){a.css("display","none");return}var c=SR.Vector.min(e,d);var b=SR.Vector.max(e,d);a.css("display","");a.css("left",c[0]+"px");a.css("top",c[1]+"px");a.css("width",(b[0]-c[0])+"px");a.css("height",(b[1]-c[1])+"px")},this))},_onMouseDown:function(c){c.preventDefault();var a=this._getPointByEvent(c);if(c.which===1){this.selectionPoint1.set(a);this.selectionPoint2.set(a)}if(c.which===3){var b=SR.Vector.floor(SR.xyToIj(a));this.level.units.$filter(function(d){return d.selected.get()},this).each(function(d){d.send(this.level,b)},this)}},_onMouseMove:function(b){var a=this._getPointByEvent(b);this.selectionPoint2.set(a)},_onMouseUp:function(g){var h=this.selectionPoint1.get();var f=this.selectionPoint2.get();this.selectionPoint1.set(null);this.selectionPoint2.set(null);if(!h||!f){return}var d=SR.Vector.min(h,f);var b=SR.Vector.max(h,f);var c=SR.Vector.floor(SR.xyToIj(d));var a=SR.Vector.floor(SR.xyToIj(b));this.level.units.each(function(e){e.selected.set(e.controllable&&SR.Vector.isBetween(e.ij.get(),c,a))},this)},_getPointByEvent:function(a){var b=this.el.offset();return[a.pageX-b.left,a.pageY-b.top]}});(window.viewha||JW.UI).template(SR.LevelView,{main:'<div jwclass="sr-level"><div jwid="matrix"></div><div jwid="obstacles"></div><div jwid="units"></div><div jwid="selection"></div></div>'});SR.Matrix=function(b){SR.Matrix._super.call(this);this.size=b;this.cells=new Array(b);for(var a=0;a<b;++a){this.cells[a]=new Array(b)}};JW.extend(SR.Matrix,JW.Class,{getCell:function(a){return JW.get(this.cells,a)},setCell:function(a,b){this.cells[a[0]][a[1]]=b},fill:function(c){for(var b=0;b<this.size;++b){for(var a=0;a<this.size;++a){this.cells[b][a]=c}}},inMatrix:function(a){return(a[0]>=0)&&(a[0]<this.size)&&(a[1]>=0)&&(a[1]<this.size)},ijRandom:function(){return[SR.random(this.size),SR.random(this.size)]},ijCenter:function(){return SR.Vector.round(SR.Vector.mult([this.size,this.size],0.5))},getRect:function(a,b){return{iMin:Math.max(0,a[0]-b),iMax:Math.min(this.size-1,a[0]+b),jMin:Math.max(0,a[1]-b),jMax:Math.min(this.size-1,a[1]+b)}},getSideDistance:function(a){return Math.min(a[0],a[1],this.size-a[0]-1,this.size-a[1]-1)},every:function(e,d){for(var c=0;c<this.size;++c){for(var a=0;a<this.size;++a){var b=[c,a];if(e.call(d||this,this.getCell(b),b)===false){return false}}}return true},some:function(b,a){return !this.every(function(){return !b.apply(this,arguments)},a||this)},eachWithin:function(c,a,h,k){var b=Math.ceil(Math.sqrt(a));var f=this.getRect(c,b);for(var e=f.iMin;e<=f.iMax;++e){for(var d=f.jMin;d<=f.jMax;++d){var g=[e,d];if(SR.Vector.lengthSqr(SR.Vector.diff(g,c))<=a){h.call(k||this,this.getCell(g),g)}}}},everyWithin8:function(d,h,g,e){var f=this.getRect(d,h);for(var c=f.iMin;c<=f.iMax;++c){for(var a=f.jMin;a<=f.jMax;++a){var b=[c,a];if(g.call(e||this,this.getCell(b),b)===false){return false}}}return true},someWithin8:function(a,d,c,b){return !this.everyWithin8(a,d,function(){return !c.apply(this,arguments)},b||this)}});SR.Obstacle=function(a){SR.Obstacle._super.call(this);this.type=a.type;this.ij=a.ij;this.direction=a.direction};JW.extend(SR.Obstacle,JW.Class,{});SR.ObstacleType=function(a){SR.ObstacleType._super.call(this);this.id=a.id;this.size=a.size};JW.extend(SR.ObstacleType,JW.Class);JW.makeRegistry(SR.ObstacleType);SR.ObstacleType.registerItem(new SR.ObstacleType({id:"bed",size:[10,20]}));SR.ObstacleView=function(a){SR.ObstacleView._super.call(this);this.obstacle=a
};JW.extend(SR.ObstacleView,JW.UI.Component,{renderRoot:function(b){b.addClass("sr-obstacle");b.attr("sr-type",this.obstacle.type.id);b.attr("sr-direction",this.obstacle.direction);var c=SR.ijToXy(this.obstacle.ij);b.css("left",c[0]+"px");b.css("top",c[1]+"px");var a=SR.ijToXy(this.obstacle.type.size);b.css("width",a[0]+"px");b.css("height",a[1]+"px");b.css("transform","rotate("+(-90*this.obstacle.direction)+"deg)")}});SR.Unit=function(a){SR.Unit._super.call(this);this.ij=new JW.Property(a.ij);this.direction=new JW.Property(a.direction);this.movement=new JW.Property(0);this.controllable=a.controllable;this.type=a.type;this.ijTarget=new JW.Property();this.path=[];this.selected=new JW.Property(false)};JW.extend(SR.Unit,JW.Class,{move:function(d){var b=this.type.speed;while(b&&(this.path.length||this.movement.get()!==0)){var a=-this.movement.get();if(b<a){this.movement.set(this.movement.get()+b);b=0}else{if(this.path.length){b-=a;this.movement.set(-1);var c=this.path[0];this.path.splice(0,1);this.ij.set(SR.Vector.add(this.ij.get(),SR.dir4[c]));this.direction.set(c)}else{this.movement.set(0)}}}},send:function(c,a,b){this.ijTarget.set(a);this.path=c.findPath(this.ij.get(),a,b)||[]}});SR.UnitType=function(a){SR.UnitType._super.call(this);this.id=a.id;this.speed=a.speed};JW.extend(SR.UnitType,JW.Class);JW.makeRegistry(SR.UnitType);SR.UnitType.registerItem(new SR.UnitType({id:"spider",speed:0.2}));SR.UnitView=function(a){SR.UnitView._super.call(this);this.unit=a};JW.extend(SR.UnitView,JW.UI.Component,{renderRoot:function(c){c.addClass("sr-unit");c.attr("sr-type",this.unit.type.id);c.attr("sr-direction",this.unit.direction);var d=this.own(new JW.Functor([this.unit.ij,this.unit.direction,this.unit.movement],function(g,h,f){return SR.ijToXy(SR.Vector.add(g,SR.Vector.mult(SR.dir4[h],f)))},this)).target;var a=this.own(SR.getXProperty(d));var e=this.own(SR.getYProperty(d));this.own(c.jwcss("left",a));this.own(c.jwcss("top",e));c.css("width","16px");c.css("height","16px");var b=this.own(this.unit.direction.$$mapValue(function(f){return"rotate("+(-90*f)+"deg)"},this));this.own(c.jwcss("transform",b));this.own(c.jwclass("selected",this.unit.selected))}});SR.Vector={add:function(d,c){return[d[0]+c[0],d[1]+c[1]]},diff:function(d,c){return[d[0]-c[0],d[1]-c[1]]},mult:function(b,d){return[d*b[0],d*b[1]]},equal:function(d,c){return(d[0]===c[0])&&(d[1]===c[1])},length:function(b){return Math.sqrt(SR.Vector.lengthSqr(b))},lengthSqr:function(b){return b[0]*b[0]+b[1]*b[1]},length8:function(b){return Math.max(Math.abs(b[0]),Math.abs(b[1]))},lerp:function(e,d,f){return SR.Vector.add(e,SR.Vector.mult(SR.Vector.diff(d,e),f))},isBetween:function(c,d,b){return(c[0]>=d[0])&&(c[1]>=d[1])&&(c[0]<=b[0])&&(c[1]<=b[1])},round:function(b){return[Math.round(b[0]),Math.round(b[1])]},floor:function(b){return[Math.floor(b[0]),Math.floor(b[1])]},ceil:function(b){return[Math.ceil(b[0]),Math.ceil(b[1])]},min:function(d,c){return[Math.min(d[0],c[0]),Math.min(d[1],c[1])]},max:function(d,c){return[Math.max(d[0],c[0]),Math.max(d[1],c[1])]},norm8:function(b){return[JW.sgn(b[0]),JW.sgn(b[1])]},parse:function(a){a=a.split(",");return[+a[0],+a[1]]}};var application;$(function(){application=new SR.Application().renderTo("body").startLevel()});