var SR={cellSize:16,tickPerSecond:25,spiderEnergyFillingPeriod:1500,spiderEnergyPerWeb:0.1,dir4:[[0,1],[-1,0],[0,-1],[1,0]],dir8:[[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1],[1,0],[1,1]],sound:function(a){var b=new Audio();b.src="audio/"+a+".ogg";b.play()},random:function(a){return Math.floor(Math.random()*a)},getIjs4:function(b){var a=[];for(var c=0;c<4;++c){a.push(SR.Vector.add(b,SR.dir4[c]))}return a},getIjs8:function(b){var a=[];for(var c=0;c<8;++c){a.push(SR.Vector.add(b,SR.dir8[c]))}return a},ijToXy:function(a){return[SR.cellSize*a[1],SR.cellSize*a[0]]},xyToIj:function(a){return[a[1]/SR.cellSize,a[0]/SR.cellSize]},getXProperty:function(a){return a.$$mapValue(function(b){return b[0]+"px"})},getYProperty:function(a){return a.$$mapValue(function(b){return b[1]+"px"})}};SR.Application=function(){SR.Application._super.call(this);this.level=this.own(new JW.Property()).ownValue()};JW.extend(SR.Application,JW.UI.Component,{renderLevel:function(){return this.own(this.level.$$mapObject(function(a){return new SR.LevelView(a)},this))},startLevel:function(){var e=new SR.Level(40);e.matrix.fill(0);var b=[39,0];for(var c=0;c<4;++c){for(var a=0;a<39;++a){e.matrix.setCell(b,2);b=SR.Vector.add(b,SR.dir4[c])}}for(var a=0;a<15;++a){e.matrix.setCell([24,a+1],1);if(a<3||a>10){e.matrix.setCell([38-a,15],1)}}e.obstacles.add(new SR.Obstacle({type:SR.ObstacleType.getItem("bed"),ij:[1,10],direction:3}));e.units.add(new SR.Unit({ij:[35,5],direction:1,controllable:true,type:SR.UnitType.getItem("spider")}));e.units.add(new SR.Unit({ij:[20,20],direction:0,controllable:false,type:SR.UnitType.getItem("habitant")}));e.initPathingMatrices();this.level.set(e);return this}});(window.viewha||JW.UI).template(SR.Application,{main:'<div jwclass="sr-application"><div jwid="level"></div></div>'});SR.Level=function(a){SR.Level._super.call(this);this.tick=new JW.Property(0);this.matrix=new SR.Matrix(a);this.obstacles=this.own(new JW.ObservableArray()).ownItems();this.units=this.own(new JW.ObservableArray()).ownItems();this.webCells=this.own(new JW.ObservableArray()).ownItems();this.paused=new JW.Property(false);this.own(this.paused.$$mapObject(function(b){return b?null:new JW.Interval(this.onTick,this,1000/SR.tickPerSecond)},this));this.pathingMatrices=[]};JW.extend(SR.Level,JW.Class,{initPathingMatrices:function(){this.pathingMatrices=[];this.pathingMatrices.push(this._initMainPathingMatrix());for(var a=0;a<3;++a){this.pathingMatrices.push(this._extendPathingMatrix(this.pathingMatrices[a]))}},onTick:function(){this.tick.set(this.tick.get()+1);this.units.each(JW.byMethod("move",[this]))},isPassable:function(b,a,c){a=a||0;if(!this.pathingMatrices[a].getCell(b)){return false}if(c){var e=this.units.some(function(f){return SR.Vector.equal(f.ij.get(),b)},this);if(e){return false}}return true},findPath:function(f,c,b,e){var a=this.getDistanceMatrix(f,c,b,e);return this.backtracePath(a,c)},getDistanceMatrix:function(o,c,a,e){var m=new SR.Matrix(this.matrix.size);m.setCell(o,0);if(SR.Vector.equal(o,c)){return m}var i=[o];var l=0;var f=0;var j=0;while(l<i.length){if(l==j){++f;j=i.length;if(m.getCell(c)!=null){return m}}var h=i[l++];for(var g=0;g<SR.dir4.length;++g){var k=SR.Vector.add(h,SR.dir4[g]);var b=m.getCell(k);if(!this.matrix.inMatrix(k)||(b!=null)){continue}var n=this.matrix.getCell(k);if(!this.isPassable(k,a,e)){continue}m.setCell(k,f);i.push(k)}}return m},backtracePath:function(a,b){var g=[];var i=a.getCell(b);if(i==null){return null}while(true){if(i===0){g.reverse();return g}--i;var e,f;var h=SR.random(4);for(d=0;d<4;++d){var e=(d+h)%4;f=SR.Vector.diff(b,SR.dir4[e]);if(a.getCell(f)===i){break}}g.push(e);b=f}},getSelectedUnits:function(){return this.units.$filter(function(a){return a.selected.get()},this)},isWebCell:function(a){return this.webCells.some(function(b){return SR.Vector.equal(b,a)},this)},_initMainPathingMatrix:function(){var a=new SR.Matrix(this.matrix.size);for(var e=0;e<a.size;++e){for(var b=0;b<a.size;++b){var c=[e,b];a.setCell(c,this._isPassable(c))}}return a},_extendPathingMatrix:function(g){var b=new SR.Matrix(this.matrix.size);for(var f=0;f<b.size;++f){for(var c=0;c<b.size;++c){var e=[f,c];var k=true;for(var h=0;h<8;++h){var a=SR.Vector.add(e,SR.dir8[h]);if(!b.inMatrix(a)||!g.getCell(a)){var k=false;break}}b.setCell(e,k)}}return b},_isPassable:function(b){if(this.matrix.getCell(b)!==0){return false}var a=this.obstacles.some(function(g){var k=SR.dir4[g.direction];var i=SR.Vector.diff(g.type.size,[1,1]);var f=[k[1]*i[0]+k[0]*i[1],-k[0]*i[0]+k[1]*i[1]];var j=g.ij;var h=SR.Vector.add(j,f);var e=SR.Vector.min(j,h);var c=SR.Vector.max(j,h);return SR.Vector.isBetween(b,e,c)},this);if(a){return false}return true}});SR.LevelView=function(a){SR.LevelView._super.call(this);this.level=a;this.cells=new SR.Matrix(this.level.matrix.size);this.selectionPoint1=new JW.Property();this.selectionPoint2=new JW.Property()};JW.extend(SR.LevelView,JW.UI.Component,{renderRoot:function(a){this.own(a.jwon("mousedown",this._onMouseDown,this));this.own($(window).jwon("mousemove",this._onMouseMove,this));this.own($(window).jwon("mouseup",this._onMouseUp,this));this.own(a.jwon("contextmenu",JW.UI.preventDefault));this.own($(window).jwon("keypress",this._onKeyPress,this))},renderMatrix:function(g){var h=this.level;for(var f=0;f<h.matrix.size;++f){var c=jQuery('<div class="sr-level-row"></div>');for(var b=0;b<h.matrix.size;++b){var e=[f,b];var a=jQuery('<div class="sr-level-cell"></div>');this.cells.setCell(e,a);a.attr("sr-i",f);a.attr("sr-j",b);a.attr("sr-type",this.level.matrix.getCell(e));c.append(a)}c.append('<div class="sr-clear"></div>');g.append(c)}},renderObstacles:function(){return this.own(this.level.obstacles.$$mapObjects(function(a){return new SR.ObstacleView(a)},this))},renderUnits:function(){return this.own(this.level.units.$$mapObjects(function(a){return a.type.viewCreator(a)},this))},renderWebCells:function(a){this.own(this.level.webCells.createMapper({createItem:function(c){var b=$('<div class="sr-web-cell"></div>');var e=SR.ijToXy(c);b.css("left",e[0]+"px");b.css("top",e[1]+"px");a.append(b);return b},destroyItem:function(b){b.remove()},scope:this}))},renderSelection:function(a){this.own(new JW.Updater([this.selectionPoint1,this.selectionPoint2],function(f,e){if(!f||!e){a.css("display","none");return}var c=SR.Vector.min(f,e);var b=SR.Vector.max(f,e);a.css("display","");a.css("left",c[0]+"px");a.css("top",c[1]+"px");a.css("width",(b[0]-c[0])+"px");a.css("height",(b[1]-c[1])+"px")},this))},_onMouseDown:function(c){c.preventDefault();var a=this._getPointByEvent(c);if(c.which===1){this.selectionPoint1.set(a);this.selectionPoint2.set(a)}if(c.which===3){var b=SR.Vector.floor(SR.xyToIj(a));this.level.getSelectedUnits().each(function(e){e.send(this.level,b)},this)}},_onMouseMove:function(b){var a=this._getPointByEvent(b);this.selectionPoint2.set(a)},_onMouseUp:function(h){var i=this.selectionPoint1.get();var g=this.selectionPoint2.get();this.selectionPoint1.set(null);this.selectionPoint2.set(null);if(!i||!g){return}var f=SR.Vector.min(i,g);var b=SR.Vector.max(i,g);var c=SR.Vector.floor(SR.xyToIj(f));var a=SR.Vector.floor(SR.xyToIj(b));this.level.units.each(function(e){e.selected.set(e.controllable&&SR.Vector.isBetween(e.ij.get(),c,a))},this)},_onKeyPress:function(b){if(b.keyCode===32){b.preventDefault();var c=this.level.getSelectedUnits();var a=c.some(function(e){return !e.active.get()},this);c.each(function(e){e.active.set(a)},this)}},_getPointByEvent:function(a){var b=this.el.offset();return[a.pageX-b.left,a.pageY-b.top]}});(window.viewha||JW.UI).template(SR.LevelView,{main:'<div jwclass="sr-level"><div jwid="matrix"></div><div jwid="obstacles"></div><div jwid="web-cells"></div><div jwid="units"></div><div jwid="selection"></div></div>'});SR.Matrix=function(b){SR.Matrix._super.call(this);this.size=b;this.cells=new Array(b);for(var a=0;a<b;++a){this.cells[a]=new Array(b)}};JW.extend(SR.Matrix,JW.Class,{getCell:function(a){return JW.get(this.cells,a)},setCell:function(a,b){this.cells[a[0]][a[1]]=b
},fill:function(c){for(var b=0;b<this.size;++b){for(var a=0;a<this.size;++a){this.cells[b][a]=c}}},inMatrix:function(a){return(a[0]>=0)&&(a[0]<this.size)&&(a[1]>=0)&&(a[1]<this.size)},ijRandom:function(){return[SR.random(this.size),SR.random(this.size)]},ijCenter:function(){return SR.Vector.round(SR.Vector.mult([this.size,this.size],0.5))},getRect:function(a,b){return{iMin:Math.max(0,a[0]-b),iMax:Math.min(this.size-1,a[0]+b),jMin:Math.max(0,a[1]-b),jMax:Math.min(this.size-1,a[1]+b)}},getSideDistance:function(a){return Math.min(a[0],a[1],this.size-a[0]-1,this.size-a[1]-1)},every:function(f,e){for(var c=0;c<this.size;++c){for(var a=0;a<this.size;++a){var b=[c,a];if(f.call(e||this,this.getCell(b),b)===false){return false}}}return true},some:function(b,a){return !this.every(function(){return !b.apply(this,arguments)},a||this)},eachWithin:function(c,a,k,l){var b=Math.ceil(Math.sqrt(a));var g=this.getRect(c,b);for(var f=g.iMin;f<=g.iMax;++f){for(var e=g.jMin;e<=g.jMax;++e){var h=[f,e];if(SR.Vector.lengthSqr(SR.Vector.diff(h,c))<=a){k.call(l||this,this.getCell(h),h)}}}},everyWithin8:function(e,k,h,f){var g=this.getRect(e,k);for(var c=g.iMin;c<=g.iMax;++c){for(var a=g.jMin;a<=g.jMax;++a){var b=[c,a];if(h.call(f||this,this.getCell(b),b)===false){return false}}}return true},someWithin8:function(a,e,c,b){return !this.everyWithin8(a,e,function(){return !c.apply(this,arguments)},b||this)}});SR.Obstacle=function(a){SR.Obstacle._super.call(this);this.type=a.type;this.ij=a.ij;this.direction=a.direction};JW.extend(SR.Obstacle,JW.Class,{});SR.ObstacleType=function(a){SR.ObstacleType._super.call(this);this.id=a.id;this.size=a.size};JW.extend(SR.ObstacleType,JW.Class);JW.makeRegistry(SR.ObstacleType);SR.ObstacleType.registerItem(new SR.ObstacleType({id:"bed",size:[10,20]}));SR.ObstacleView=function(a){SR.ObstacleView._super.call(this);this.obstacle=a};JW.extend(SR.ObstacleView,JW.UI.Component,{renderRoot:function(b){b.addClass("sr-obstacle");b.attr("sr-type",this.obstacle.type.id);var c=SR.ijToXy(this.obstacle.ij);b.css("left",c[0]+"px");b.css("top",c[1]+"px");var a=SR.ijToXy(this.obstacle.type.size);b.css("width",a[0]+"px");b.css("height",a[1]+"px");b.css("transform","rotate("+(-90*this.obstacle.direction)+"deg)")}});SR.Unit=function(a){SR.Unit._super.call(this);this.ij=new JW.Property(a.ij);this.direction=new JW.Property(a.direction);this.movement=new JW.Property(0);this.controllable=a.controllable;this.type=a.type;this.ijTarget=new JW.Property();this.path=[];this.selected=new JW.Property(false);this.animationTick=new JW.Property(0);this.energy=new JW.Property(1);this.active=new JW.Property(false)};JW.extend(SR.Unit,JW.Class,{move:function(e){var b=this.type.speed;if(this.path.length||this.movement.get()!==0){this.animationTick.set(this.animationTick.get()+b)}while(b&&(this.path.length||this.movement.get()!==0)){var a=-this.movement.get();if(b<a){this.movement.set(this.movement.get()+b);b=0}else{if(this.path.length){b-=a;this.movement.set(-1);var c=this.path[0];this.path.splice(0,1);this.ij.set(SR.Vector.add(this.ij.get(),SR.dir4[c]));this.direction.set(c)}else{this.movement.set(0);this.animationTick.set(0)}}}this.type.mover(this,e)},send:function(c,a,b){this.ijTarget.set(a);this.path=c.findPath(this.ij.get(),a,this.type.size,b)||[]}});SR.UnitType=function(a){SR.UnitType._super.call(this);this.id=a.id;this.speed=a.speed;this.size=a.size||0;this.viewCreator=a.viewCreator||this.viewCreator;this.mover=a.mover||this.mover};JW.extend(SR.UnitType,JW.Class,{viewCreator:function(a){return new SR.UnitView(a)},mover:function(a,b){}});JW.makeRegistry(SR.UnitType);SR.UnitType.registerItem(new SR.UnitType({id:"spider",speed:0.2,viewCreator:function(a){return new SR.SpiderUnitView(a)},mover:function(c,f){if(f.isWebCell(c.ij.get())){c.energy.set(Math.min(1,c.energy.get()+1/SR.spiderEnergyFillingPeriod));return}if(!c.active.get()){return}if(c.energy.get()<SR.spiderEnergyPerWeb){c.active.set(false);return}var b=0;for(var e=0;e<4;++e){var a=SR.Vector.add(c.ij.get(),SR.dir4[e]);if(f.isWebCell(a)||!f.isPassable(a)){++b}}if(b<2){return}c.energy.set(c.energy.get()-SR.spiderEnergyPerWeb);f.webCells.add(c.ij.get())}}));SR.UnitType.registerItem(new SR.UnitType({id:"habitant",speed:0.1,size:3,viewCreator:function(a){return new SR.HabitantUnitView(a)}}));SR.UnitView=function(a){SR.UnitView._super.call(this);this.unit=a};JW.extend(SR.UnitView,JW.UI.Component,{renderRoot:function(b){var c=this.own(new JW.Functor([this.unit.ij,this.unit.direction,this.unit.movement],function(g,h,f){return SR.ijToXy(SR.Vector.add(g,SR.Vector.mult(SR.dir4[h],f)))},this)).target;var a=this.own(SR.getXProperty(c));var e=this.own(SR.getYProperty(c));this.own(b.jwcss("left",a));this.own(b.jwcss("top",e))},renderView:function(c){c.attr("sr-type",this.unit.type.id);var b=(2*this.unit.type.size+1)*SR.cellSize;var e=b/2;c.css("width",b+"px");c.css("height",b+"px");c.css("left",-e+"px");c.css("top",-e+"px");var a=this.own(this.unit.direction.$$mapValue(function(f){return"rotate("+(-90*f)+"deg)"},this));this.own(c.jwcss("transform",a));this.own(c.jwclass("selected",this.unit.selected));this.own(c.jwclass("active",this.unit.active))}});(window.viewha||JW.UI).template(SR.UnitView,{main:'<div jwclass="sr-unit"><div jwid="view"></div></div>'});SR.HabitantUnitView=function(a){SR.HabitantUnitView._super.call(this,a);this.animationPoint=null};JW.extend(SR.HabitantUnitView,SR.UnitView,{bodyRotationAmplitude:10,legExtrusionAmplitude:40,animationPeriod:4,beforeRender:function(){this._super();this.animationPoint=this.own(this.unit.animationTick.$$mapValue(function(a){return 2*Math.abs(2*JW.smod(a/this.animationPeriod+0.25,1))-1},this))},renderBody:function(b){var a=this.own(this.animationPoint.$$mapValue(function(c){return"rotate("+(-c*this.bodyRotationAmplitude)+"deg)"},this));this.own(b.jwcss("transform",a))},renderLeftLeg:function(a){this._renderLeg(a,1)},renderRightLeg:function(a){this._renderLeg(a,-1)},_renderLeg:function(a,b){this.own(new JW.Updater([this.animationPoint],function(c){c*=b;a.css("left",(c>=0)?"56px":(56+this.legExtrusionAmplitude*c+"px"));a.css("width",Math.abs(c)*this.legExtrusionAmplitude+"px");a.css("background-position-x",(c>=0)?(this.legExtrusionAmplitude*c-48+"px"):"0")},this))}});(window.viewha||JW.UI).template(SR.HabitantUnitView,{main:'<div jwclass="sr-habitant" class="sr-unit"><div jwid="view" class="sr-unit-view"><div jwid="left-leg"></div><div jwid="right-leg"></div><div jwid="body"></div></div></div>'});SR.SpiderUnitView=function(a){SR.SpiderUnitView._super.call(this,a)};JW.extend(SR.SpiderUnitView,SR.UnitView,{renderAss:function(b){var a=this.own(this.unit.energy.$$mapValue(function(c){return"scale("+(c*0.6+0.4)+")"},this));this.own(b.jwcss("transform",a))}});(window.viewha||JW.UI).template(SR.SpiderUnitView,{main:'<div jwclass="sr-spider" class="sr-unit"><div jwid="view" class="sr-unit-view"><div jwid="ass"></div></div></div>'});SR.Vector={add:function(e,c){return[e[0]+c[0],e[1]+c[1]]},diff:function(e,c){return[e[0]-c[0],e[1]-c[1]]},mult:function(b,e){return[e*b[0],e*b[1]]},equal:function(e,c){return(e[0]===c[0])&&(e[1]===c[1])},length:function(b){return Math.sqrt(SR.Vector.lengthSqr(b))},lengthSqr:function(b){return b[0]*b[0]+b[1]*b[1]},length8:function(b){return Math.max(Math.abs(b[0]),Math.abs(b[1]))},lerp:function(f,e,g){return SR.Vector.add(f,SR.Vector.mult(SR.Vector.diff(e,f),g))},isBetween:function(c,e,b){return(c[0]>=e[0])&&(c[1]>=e[1])&&(c[0]<=b[0])&&(c[1]<=b[1])},round:function(b){return[Math.round(b[0]),Math.round(b[1])]},floor:function(b){return[Math.floor(b[0]),Math.floor(b[1])]},ceil:function(b){return[Math.ceil(b[0]),Math.ceil(b[1])]},min:function(e,c){return[Math.min(e[0],c[0]),Math.min(e[1],c[1])]},max:function(e,c){return[Math.max(e[0],c[0]),Math.max(e[1],c[1])]},norm8:function(b){return[JW.sgn(b[0]),JW.sgn(b[1])]},parse:function(a){a=a.split(",");return[+a[0],+a[1]]}};var application;$(function(){application=new SR.Application().renderTo("body").startLevel()});